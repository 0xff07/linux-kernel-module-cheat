#!/usr/bin/env bash
set -e
cd buildroot
#make BR2_EXTERNAL="$(pwd)/../kernel_module" qemu_x86_64_defconfig
#make BR2_EXTERNAL="$(pwd)/../kernel_module" qemu_arm_vexpress_defconfig
make BR2_EXTERNAL="$(pwd)/../kernel_module" qemu_arm_versatile_defconfig
# Can't get rid of this for now.
# http://stackoverflow.com/questions/44078245/is-it-possible-to-use-config-fragments-with-buildroots-config
cat ../buildroot_config_fragment >> .config
env -u LD_LIBRARY_PATH make BR2_JLEVEL="$(($(nproc) - 2))" kernel_module-rebuild all
cd ..
./runqemu "$@"
